import io.delta.tables.DeltaTable;
import org.apache.spark.sql.Dataset;
import org.apache.spark.sql.Row;
import org.apache.spark.sql.SparkSession;

import java.util.HashMap;
import java.util.Map;

public class ReadDeltaTableWithMultiplePartitionFilters {
    public static void main(String[] args) {
        // Initialize Spark session
        SparkSession spark = SparkSession.builder()
                .appName("ReadDeltaTableWithMultiplePartitionFilters")
                .master("local") // Use "local" for local testing
                .getOrCreate();

        // Sample Delta table path with multiple partition information
        String deltaTablePath = "/path/to/delta-table/year=2023/month=01/day=15/region=US/";

        // Extract partition key-value pairs from the path
        Map<String, String> partitions = extractPartitions(deltaTablePath);

        // Load the Delta table (base path without partition values)
        String basePath = "/path/to/delta-table/";
        DeltaTable deltaTable = DeltaTable.forPath(spark, basePath);

        // Build filters dynamically from partition values
        Dataset<Row> partitionedData = deltaTable.toDF();
        for (Map.Entry<String, String> entry : partitions.entrySet()) {
            partitionedData = partitionedData.filter(entry.getKey() + " = " + entry.getValue());
        }

        // Show the filtered data
        partitionedData.show();

        // Stop Spark session
        spark.stop();
    }

    // Method to extract partition key-value pairs from the path
    public static Map<String, String> extractPartitions(String deltaTablePath) {
        Map<String, String> partitions = new HashMap<>();
        String[] pathParts = deltaTablePath.split("/");

        for (String part : pathParts) {
            if (part.contains("=")) {
                String[] partitionKeyValue = part.split("=");
                partitions.put(partitionKeyValue[0], partitionKeyValue[1]);  // Store partition key and value
            }
        }

        return partitions;
    }
}
